gcloud compute instances create zk-bench-2 \
    --project=fk-varadhi-oss-d --zone=asia-south1-c --machine-type=e2-standard-2 \
    --network-interface=stack-type=IPV4_ONLY,subnet=projects/fk-network-svcs-ab12/regions/asia-south1/subnetworks/fk-preprod-sub-ass1-primary-rb43,no-address \
    --metadata=^,@^vpc-subnet-name=fk-preprod-sub-ass1-primary-rb43,@startup-script=\#\!/bin/bash$'\n'$'\n'apt-get\ -q\ -o\ Dir::Etc::sourcelist=\"sources.list.d/google-cloud.list\"\ -o\ Dir::Etc::sourceparts=\"-\"\ -o\ APT::Get::List-Cleanup=\"0\"\ -o\ Acquire::http::Timeout=\"10\"\ -o\ Acquire::ftp::Timeout=\"10\"\ update$'\n'$'\n'apt-get\ install\ -y\ jq$'\n'$'\n'get_meta\(\)\{$'\n'\ \ http_code=\$\(curl\ -w\ \"\%\{http_code\}\"\ -o\ /dev/null\ -s\ \$1\ -H\ \"Metadata-Flavor:\ Google\"\)$'\n'\ \ \#echo\ the\ response\ code\ is\ \$http_code$'\n'\ \ if\ \[\[\ \$http_code\ \!=\ 200\ \]\]$'\n'\ \ then$'\n'\ \ \ \ CONTENT=\"\"$'\n'\ \ \ \ ERROR=\"true\"$'\n'\ \ else$'\n'\ \ \ \ CONTENT=\"\$\(curl\ \$1\ -H\ \"Metadata-Flavor:\ Google\"\)\"$'\n'\ \ \ \ ERROR=\"false\"$'\n'\ \ fi$'\n'\}$'\n'$'\n'mkdir\ -p\ /etc/default/megh/$'\n'$'\n'FILE=\"/etc/default/megh/instance_metadata.json\"$'\n'$'\n'get_meta\ \"http://metadata.google.internal/computeMetadata/v1/instance/id\"$'\n'ID=\$CONTENT$'\n'$'\n'get_meta\ \"http://metadata.google.internal/computeMetadata/v1/project/attributes/app\"\ \#custom\ metadata$'\n'if\ \[\ \"\$ERROR\"\ ==\ \"true\"\ \]\;\ then$'\n'\ \ exit\ 1$'\n'fi$'\n'APP=\$CONTENT$'\n'$'\n'get_meta\ \"http://metadata.google.internal/computeMetadata/v1/project/project-id\"$'\n'PROJECT_ID=\$CONTENT$'\n'$'\n'get_meta\ \"http://metadata.google.internal/computeMetadata/v1/instance/attributes/created-by\"$'\n'INSTANCE_GROUP=\$\(basename\ \$CONTENT\)$'\n'$'\n'get_meta\ \"http://metadata.google.internal/computeMetadata/v1/instance/machine-type\"$'\n'INSTANCE_TYPE=\$\(basename\ \$CONTENT\)$'\n'$'\n'get_meta\ \"http://metadata.google.internal/computeMetadata/v1/instance/hostname\"$'\n'HOSTNAME=\$CONTENT$'\n'$'\n'get_meta\ \"http://metadata.google.internal/computeMetadata/v1/instance/disks/\?recursive=true\&alt=json\"$'\n'temp=\(\$CONTENT\)$'\n'DISKS=\"\[\]\"$'\n'temp_len=\$\(echo\ \$temp\ \|\ jq\ length\)$'\n'for\ i\ in\ \$\(seq\ 0\ \$\(\(\$temp_len-1\)\)\)$'\n'do$'\n'\ \ DISK_TYPE=\$\(echo\ \$temp\ \|\ jq\ -c\ \".\[\$i\].type\"\)\;$'\n'\ \ item=\$\(jq\ -nc\ --arg\ disk_type\ \$DISK_TYPE\ \"\{disk_type:\ \$DISK_TYPE\}\"\)$'\n'\ \ DISKS=\$\(echo\ \$DISKS\ \|\ jq\ -c\ \".\[\$i\]\ \|=\ .\+\ \$item\"\)$'\n'done$'\n'$'\n'get_meta\ \"http://metadata.google.internal/computeMetadata/v1/instance/network-interfaces/\?recursive=true\&alt=json\"$'\n'temp=\(\$CONTENT\)$'\n'NET_INT=\"\[\]\"$'\n'temp_len=\$\(echo\ \$temp\ \|\ jq\ length\)$'\n'for\ i\ in\ \$\(seq\ 0\ \$\(\(\$temp_len-1\)\)\)$'\n'do$'\n'\ \ IPV4=\$\(echo\ \$temp\ \|\ jq\ -c\ \".\[\$i\].ip\"\)\;$'\n'\ \ HWADDR=\$\(echo\ \$temp\ \|\ jq\ -c\ \".\[\$i\].mac\"\)\;$'\n'\ \ item=\$\(jq\ -nc\ --arg\ ipv4\ \$IPV4\ --arg\ hw_address\ \$HWADDR\ \"\{ipv4:\ \$IPV4,\ hw_address:\ \$HWADDR\}\"\)$'\n'\ \ NET_INT=\$\(echo\ \$NET_INT\ \|\ jq\ -c\ \".\[\$i\]\ \|=\ .\+\ \$item\"\)$'\n'done$'\n'$'\n'MACHINE_TYPE=\"vm\"$'\n'$'\n'get_meta\ \"http://metadata.google.internal/computeMetadata/v1/instance/zone\"\ \#GCP\ zone$'\n'FAULT_ZONE=\$\(basename\ \$CONTENT\)$'\n'$'\n'ZONE=\$\(echo\ \$FAULT_ZONE\ \|\ sed\ \'s\|\\\(.\*\\\)-.\*\|\\1\|\'\)$'\n'$'\n'get_meta\ \"http://metadata.google.internal/computeMetadata/v1/instance/attributes/vpc-subnet-name\"\ \#custom\ metadata$'\n'VPC_SUBNET_NAME=\$CONTENT$'\n'$'\n'get_meta\ \"http://metadata.google.internal/computeMetadata/v1/instance/network-interfaces/0/network\"$'\n'VPC_NAME=\$\(basename\ \$CONTENT\)$'\n'$'\n'DETAIL=\$\(jq\ -nc\ \\$'\n'\ --argjson\ disks\ \$DISKS\ --argjson\ network_interfaces\ \$NET_INT\ \"\{disks:\ \$DISKS,\ network_interfaces:\ \$NET_INT\}\"\)$'\n'$'\n'cat\ \>\ \$FILE\ \<\<EOF$'\n'\{$'\n'\ \ \"id\":\ \"\$ID\",$'\n'\ \ \"app\":\ \"\$APP\",$'\n'\ \ \"project-id\":\ \"\$PROJECT_ID\",$'\n'\ \ \"instance_group\":\ \"\$INSTANCE_GROUP\",$'\n'\ \ \"instance_type\":\ \"\$INSTANCE_TYPE\",$'\n'\ \ \"hostname\":\ \"\$HOSTNAME\",$'\n'\ \ \"detail\":\ \$DETAIL,$'\n'\ \ \"machine_type\":\ \"\$MACHINE_TYPE\",$'\n'\ \ \"zone\":\ \"\$ZONE\",$'\n'\ \ \"fault_zone\":\ \"\$FAULT_ZONE\",$'\n'\ \ \"vpc_subnet_name\":\ \"\$VPC_SUBNET_NAME\",$'\n'\ \ \"vpc_name\":\ \"\$VPC_NAME\"$'\n'\}$'\n'EOF$'\n'$'\n'\#\ Installing\ bastion\ agent$'\n'cd\ /etc/apt/sources.list.d/$'\n'FILE=\"bastion.list\"$'\n'if\ \[\ -f\ \"\$FILE\"\ \]\;\ then$'\n'\ \ if\ \!\ grep\ -Fq\ \"deb\ \[trusted=yes\]\ http://10.19.1.12/iaas\ iaas\ flipkart\"\ \"\$FILE\"\ \;\ then$'\n'\ \ \	echo\ \'deb\ \[trusted=yes\]\ http://10.19.1.12/iaas\ iaas\ flipkart\'\ \>\>\ \$FILE$'\n'\ \ fi$'\n'else$'\n'\ \ echo\ \'deb\ \[trusted=yes\]\ http://10.19.1.12/iaas\ iaas\ flipkart\'\ \>\ \$FILE$'\n'fi$'\n'$'\n'apt-get\ -q\ -o\ Dir::Etc::sourcelist=\"sources.list.d/\$FILE\"\ -o\ Dir::Etc::sourceparts=\"-\"\ -o\ APT::Get::List-Cleanup=\"0\"\ -o\ Acquire::http::Timeout=\"10\"\ -o\ Acquire::ftp::Timeout=\"10\"\ update$'\n'$'\n'apt-get\ -y\ install\ fk-bastion-agent$'\n'$'\n'\#\ Installing\ User\ setup\ script$'\n'get_meta\ \"http://metadata.google.internal/computeMetadata/v1/instance/attributes/user-script\"$'\n'if\ \[\ \$ERROR\ \!=\ \"true\"\ \]\;\ then$'\n'\ \ eval\ echo\ \"\$CONTENT\"$'\n'fi$'\n',@enable-oslogin=true \
    --maintenance-policy=MIGRATE --provisioning-model=STANDARD \
    --service-account=fk-varadhi-oss-d-sa@fk-varadhi-oss-d.iam.gserviceaccount.com \
    --scopes=https://www.googleapis.com/auth/cloud-platform \
    --create-disk=auto-delete=yes,boot=yes,device-name=zk-bench-2,image=projects/fk-virt-infra/global/images/fk-bullseye-golden-image-v20230509,mode=rw,size=10,type=projects/fk-varadhi-oss-d/zones/asia-south1-c/diskTypes/pd-balanced \
    --shielded-secure-boot --shielded-vtpm --shielded-integrity-monitoring \
    --labels=goog-ec-src=vm_add-gcloud \
    --reservation-affinity=any